RELATÓRIO TÉCNICO DE ANÁLISE DE SEGURANÇA DE CÓDIGO
Repositório: thiagodiasdigital/ache-sucatas-v13
Data da Análise: 19/01/2026
Ferramenta de Análise: CodeQL (GitHub Code Scanning)
Branch Analisada: master
Total de Alertas Abertos: 46
Total de Alertas Fechados: 99

1. RESUMO EXECUTIVO
A análise de segurança do repositório ache-sucatas-v13 identificou 46 vulnerabilidades abertas detectadas pelo CodeQL. Destas vulnerabilidades, 2 são classificadas como de ALTA severidade (mitigadas mas não eliminadas), enquanto as demais são classificadas como Note (informativas) representando problemas de qualidade de código.

Distribuição por Severidade:
Severidade      Quantidade    Percentual
High            2             4.3%
Note            44            95.7%

Linguagens Afetadas:
- Python (principal)
- PLpgSQL
- TypeScript
- JavaScript
- Shell
- CSS
- HTML

2. VULNERABILIDADES DE ALTA SEVERIDADE

2.1 Clear-text Storage of Sensitive Information
ID do Alerta: #167
Severidade: HIGH (MITIGADO)
CWE: CWE-312, CWE-315, CWE-359
Arquivo: src/scripts/rotacionar_credenciais.py (linha 124)
Tags: security

Status: MITIGADO
Mitigação Aplicada: Adicionado chmod 600 no arquivo .env após escrita, restringindo acesso apenas ao owner.

Descrição Técnica:
O código armazena dados sensíveis (passwords) em texto claro em arquivo .env. Embora as permissões tenham sido restritas, o armazenamento ainda é em texto plano.

Justificativa de Aceitação:
Este é o propósito funcional do script (rotação de credenciais). O arquivo .env está no .gitignore e as permissões 600 garantem que apenas o owner pode ler.

2.2 Overly Permissive File Permissions
ID do Alerta: #169
Severidade: HIGH (MITIGADO)
CWE: CWE-732 (Incorrect Permission Assignment)
Arquivo: src/scripts/instalar_hooks_seguranca.py (linha 50)
Tags: security

Status: MITIGADO
Mitigação Aplicada: Permissões alteradas de 0o755 para 0o750.

Descrição Técnica:
O código define permissões de arquivo com máscara 0o750, que permite leitura/execução pelo grupo.

Justificativa de Aceitação:
Git hooks requerem permissão de execução. A permissão 0o750 é necessária para funcionamento em ambientes onde Git executa sob contexto de grupo. Usar 0o700 pode quebrar hooks em repositórios compartilhados.

3. VULNERABILIDADE CORRIGIDA

3.1 Incomplete URL Substring Sanitization
ID do Alerta: #168
Severidade: HIGH
CWE: CWE-20 (Improper Input Validation)
Arquivo: tests/test_auditor_extraction.py (linha 153)

Status: CORRIGIDO ✓
Commit: 2d123b3

Correção Aplicada:
Substituída validação por substring simples por validação segura com domínio exato + prefixo de ponto para subdomínios.

Antes (vulnerável):
  assert parsed.netloc.endswith('portal.net')
  # evil-portal.net passava na validação

Depois (seguro):
  host = parsed.netloc
  assert host == 'portal.net' or host.endswith('.portal.net')
  # evil-portal.net agora falha corretamente

4. VULNERABILIDADES DE SEVERIDADE NOTE (INFORMATIVAS)

4.1 Except Block Handles BaseException (8 ocorrências)
IDs: #166, #74, #64, #63, #62, #61, #60
Arquivos Afetados:
- src/scripts/revoke_anon_grants.py
- src/scripts/explorar_api_campos.py
- src/scripts/REVIEW_NEEDED_verificar_linkSistemaOrigem.py
- src/scripts/REVIEW_NEEDED_monitorar_reprocessamento.py
- src/scripts/REVIEW_NEEDED_atualizar_datas_api.py
- src/scripts/REVIEW_NEEDED_analisar_padroes_links.py

Descrição:
Captura de BaseException em vez de exceções específicas pode ocultar erros críticos do sistema.

Recomendação:
Capturar exceções específicas (Exception ou subclasses mais específicas).

4.2 Empty Except (12 ocorrências)
IDs: #174, #173, #172, #108, #107, #106, #105, #103, #99, #98
Arquivos Afetados:
- src/scripts/gerar_excel_final.py
- src/core/cloud_auditor_v14.py
- src/scripts/buscar_data_api_pncp.py
- src/scripts/generate_municipios_sql.py
- src/scripts/REVIEW_NEEDED_monitorar_reprocessamento.py
- src/scripts/REVIEW_NEEDED_atualizar_datas_api.py

Descrição:
Blocos except vazios suprimem silenciosamente exceções.

Recomendação:
Adicionar logging ou tratamento adequado.

4.3 Unused Import (23 ocorrências)
Arquivos Afetados:
- tests/test_auditor_extraction.py
- src/core/supabase_storage.py
- thony_reorganizar.py
- tests/test_miner_scoring.py
- src/scripts/sincronizar_storage_banco.py
- src/migrations/migrar_v13_robusto.py
- src/scripts/explorar_api_campos.py
- src/core/coleta_historica_30d.py
- src/core/cloud_auditor_v14.py
- src/scripts/buscar_data_api_pncp.py
- src/core/ache_sucatas_miner_v11.py
- src/scripts/REVIEW_NEEDED_monitorar_reprocessamento.py
- src/scripts/REVIEW_NEEDED_atualizar_datas_api.py

Recomendação:
Remover imports não utilizados com autoflake ou linter.

4.4 Outros (2 ocorrências)
- Module imported more than once: src/scripts/REVIEW_NEEDED_analisar_padroes_links.py
- Unused local variable: src/core/supabase_repository.py
- Unused global variable: src/scripts/REVIEW_NEEDED_executar_schema_supabase.py

5. HISTÓRICO DE CORREÇÕES

Data: 19/01/2026
Commits de Correção:
- 5464b44: security: Fix 3 HIGH severity CodeQL alerts
- a8b47d9: chore: Remove deprecated audit files and legacy code
- 670fafa: fix: Resolve CodeQL NOTE severity alerts
- 2d123b3: security: Fix URL sanitization bypass vulnerability (CWE-20)

Alertas Resolvidos:
- 134 → 46 alertas (redução de 66%)
- 3 HIGH → 2 HIGH mitigados + 1 corrigido
- ~60 alertas eliminados pela remoção de código legado
- ~26 alertas NOTE corrigidos em código de produção

6. ANÁLISE DE RISCO ATUALIZADA

Vulnerabilidade                  Probabilidade    Impacto    Risco Final
Clear-text Storage (mitigado)    Baixa           Médio      BAIXO
File Permissions (mitigado)      Baixa           Baixo      BAIXO
BaseException Handling           Alta            Baixo      BAIXO
Empty Except                     Alta            Baixo      BAIXO
Unused Imports                   Alta            Muito Baixo INFORMATIVO

7. CONCLUSÃO

O repositório ache-sucatas-v13 passou por processo de remediação de segurança:
- 1 vulnerabilidade HIGH foi completamente corrigida (URL Sanitization)
- 2 vulnerabilidades HIGH foram mitigadas e aceitas com justificativa
- 88 alertas foram resolvidos (66% de redução)
- 46 alertas restantes são majoritariamente informativos (NOTE)

O nível de risco geral foi reduzido de ALTO para BAIXO.

Elaborado por: Claude (Anthropic)
Data: 19/01/2026
Ferramenta de Análise: GitHub CodeQL
