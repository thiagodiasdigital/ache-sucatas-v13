{
  "audit_metadata": {
    "project": "Ache Sucatas - DaaS de Leiloes Publicos Veiculares",
    "date": "2026-01-19T00:00:00Z",
    "auditor_signature": "Claude Code Opus 4.5",
    "scope": "Secrets Management & Secure Configuration Audit (Local Only)",
    "version": "1.0.0"
  },

  "risk_level": "MEDIUM",

  "exposed_secrets_found": [
    {
      "id": "SEC-001",
      "severity": "HIGH",
      "type": "HISTORICAL_EXPOSURE",
      "description": "Credenciais foram expostas no historico do Git e rotacionadas",
      "evidence": "Commit dd57120 (2026-01-16): 'security: Remove exposed credentials and add protection mechanisms' - indica que service key e DB password estavam hardcoded",
      "file": "Git history (commits anteriores a dd57120)",
      "status": "MITIGATED",
      "remediation": "Credenciais foram rotacionadas conforme CLAUDE_FULL_5.md. Verificar via browser se rotacao foi efetiva no Supabase Dashboard."
    },
    {
      "id": "SEC-002",
      "severity": "MEDIUM",
      "type": "PARTIAL_KEY_LOGGING",
      "description": "Script de teste imprime partes da SUPABASE_SERVICE_KEY no console",
      "evidence": "Linha 30: print(f\"[OK] SUPABASE_SERVICE_KEY: {SUPABASE_KEY[:20]}...{SUPABASE_KEY[-10:]}\")",
      "file": "src/scripts/REVIEW_NEEDED_testar_supabase_conexao.py:30",
      "status": "OPEN",
      "remediation": "Remover ou mascarar completamente a chave no output. Usar apenas confirmacao booleana."
    },
    {
      "id": "SEC-003",
      "severity": "LOW",
      "type": "DOCUMENTATION_EXAMPLE",
      "description": "Documentacao contem exemplo de JWT token (truncado)",
      "evidence": "SUPABASE_KEY = \"[JWT_TOKEN_EXAMPLE_REDACTED]...\"",
      "file": "docs/GUIA_SEGURANCA_MAXIMA.md:446",
      "status": "ACCEPTABLE",
      "remediation": "Exemplo truncado e contextualizado como anti-pattern. Manter como referencia educacional."
    }
  ],

  "insecure_configurations": [
    {
      "id": "CFG-001",
      "severity": "MEDIUM",
      "type": "OVERLY_PERMISSIVE_RPC",
      "description": "Funcoes RPC concedem acesso ao role 'anon' alem de 'authenticated'",
      "evidence": "GRANT EXECUTE ON FUNCTION public.fetch_auctions_audit(JSONB) TO anon; (e outras 3 funcoes)",
      "file": "frontend/supabase/supabase_infrastructure_public.sql:355,377,393,417",
      "status": "OPEN",
      "remediation": "Avaliar se acesso anonimo e necessario. Se dados sao publicos, OK. Se nao, remover grants para 'anon'.",
      "business_impact": "Usuarios nao autenticados podem consultar dados de leiloes. Avaliar se isso e intencional para o modelo DaaS."
    },
    {
      "id": "CFG-002",
      "severity": "LOW",
      "type": "STREAMLIT_SECRETS_FILE",
      "description": "Arquivo .streamlit/secrets.toml existe no diretorio (deve estar no .gitignore)",
      "evidence": "Glob encontrou: .streamlit/secrets.toml",
      "file": ".streamlit/secrets.toml",
      "status": "CHECK_REQUIRED",
      "remediation": "Verificar se arquivo esta no .gitignore. Arquivo .streamlit/secrets.toml esta listado no .gitignore (linha 12)."
    },
    {
      "id": "CFG-003",
      "severity": "INFO",
      "type": "SECURITY_DEFINER_FUNCTIONS",
      "description": "Funcoes RPC usam SECURITY DEFINER (executam com privilegios do owner)",
      "evidence": "fetch_auctions_audit usa SECURITY DEFINER",
      "file": "frontend/supabase/supabase_infrastructure_public.sql:252",
      "status": "ACCEPTABLE",
      "remediation": "Aceitavel para funcoes que precisam acessar tabelas com RLS. Garantir que funcoes nao exponham dados indevidos."
    }
  ],

  "missing_controls": [
    {
      "id": "CTL-001",
      "severity": "MEDIUM",
      "type": "NO_DEPENDABOT",
      "description": "Dependabot nao configurado para o projeto principal",
      "evidence": "Nenhum .github/dependabot.yml encontrado na raiz do projeto",
      "remediation": "Criar .github/dependabot.yml para monitorar vulnerabilidades em dependencies Python e npm",
      "priority": "HIGH"
    },
    {
      "id": "CTL-002",
      "severity": "MEDIUM",
      "type": "NO_SECRETS_SCANNING_CI",
      "description": "CI/CD nao possui secrets scanning automatizado",
      "evidence": "Workflows ci.yml e ache-sucatas.yml nao incluem steps de secrets scanning (gitleaks, trufflehog, etc)",
      "remediation": "Adicionar step com gitleaks-action ou similar no CI pipeline",
      "priority": "HIGH"
    },
    {
      "id": "CTL-003",
      "severity": "LOW",
      "type": "PRE_COMMIT_NOT_DEFAULT",
      "description": "Pre-commit hook existe mas requer ativacao manual",
      "evidence": ".githooks/pre-commit existe, mas precisa de: git config core.hooksPath .githooks",
      "remediation": "Documentar no README ou criar script de setup que ativa hooks automaticamente",
      "priority": "MEDIUM"
    },
    {
      "id": "CTL-004",
      "severity": "LOW",
      "type": "NO_SAST_SCANNER",
      "description": "Nenhum scanner SAST (Static Application Security Testing) no CI",
      "evidence": "ci.yml usa apenas ruff (linting) e pytest (testes), nao bandit ou semgrep",
      "remediation": "Adicionar bandit para Python ou semgrep para analise de seguranca estatica",
      "priority": "MEDIUM"
    },
    {
      "id": "CTL-005",
      "severity": "INFO",
      "type": "NO_EXPLICIT_DATA_RETENTION",
      "description": "Politica de retencao de dados nao explicitamente definida no codigo",
      "evidence": "Tabelas nao possuem triggers de cleanup ou TTL. retention-days: 30 apenas em artifacts do CI.",
      "remediation": "Definir e implementar politica de retencao para dados de auditoria e logs",
      "priority": "LOW"
    }
  ],

  "positive_findings": [
    {
      "id": "POS-001",
      "control": "GITIGNORE_COMPREHENSIVE",
      "description": ".gitignore bem configurado para proteger secrets",
      "evidence": "Inclui: .env, .env.*, .streamlit/secrets.toml, *.pem, *.key, credentials.json, etc",
      "file": ".gitignore"
    },
    {
      "id": "POS-002",
      "control": "RLS_ENABLED",
      "description": "Row Level Security ativado em todas as tabelas",
      "evidence": "ALTER TABLE editais_leilao/execucoes_miner/metricas_diarias ENABLE ROW LEVEL SECURITY",
      "file": "data/sql/schemas_v13_supabase.sql:242-244"
    },
    {
      "id": "POS-003",
      "control": "PRE_COMMIT_HOOK",
      "description": "Pre-commit hook implementado para detectar secrets",
      "evidence": "Hook verifica padroes: SUPABASE_SERVICE_KEY, eyJ (JWT), password, secret, api_key",
      "file": ".githooks/pre-commit"
    },
    {
      "id": "POS-004",
      "control": "GITHUB_SECRETS",
      "description": "GitHub Actions usa secrets do repositorio corretamente",
      "evidence": "SUPABASE_URL: ${{ secrets.SUPABASE_URL }}, SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}",
      "file": ".github/workflows/ache-sucatas.yml:24-25"
    },
    {
      "id": "POS-005",
      "control": "ENV_VARS_FRONTEND",
      "description": "Frontend usa variaveis de ambiente via import.meta.env",
      "evidence": "const supabaseUrl = import.meta.env.VITE_SUPABASE_URL",
      "file": "frontend/src/lib/supabase.ts:4-5"
    },
    {
      "id": "POS-006",
      "control": "AUDIT_LOGGING",
      "description": "Sistema de audit logging implementado para rastreabilidade DaaS",
      "evidence": "Tabela audit.consumption_logs registra todas as consultas com user_id, filtros, IP",
      "file": "frontend/supabase/supabase_infrastructure_public.sql:179-213"
    },
    {
      "id": "POS-007",
      "control": "SERVICE_ROLE_ISOLATION",
      "description": "Backend usa service_role key, frontend usa anon key",
      "evidence": "Python: SUPABASE_SERVICE_KEY, Frontend: VITE_SUPABASE_ANON_KEY",
      "files": ["src/core/supabase_repository.py", "frontend/src/lib/supabase.ts"]
    },
    {
      "id": "POS-008",
      "control": "CREDENTIAL_ROTATION_SCRIPT",
      "description": "Script de rotacao de credenciais disponivel",
      "evidence": "rotacionar_credenciais.py permite atualizar .env e GitHub secrets",
      "file": "src/scripts/rotacionar_credenciais.py"
    }
  ],

  "recommended_actions": [
    {
      "priority": 1,
      "action": "Adicionar Dependabot",
      "description": "Criar .github/dependabot.yml para monitorar vulnerabilidades",
      "effort": "LOW",
      "impact": "HIGH"
    },
    {
      "priority": 2,
      "action": "Adicionar secrets scanning no CI",
      "description": "Integrar gitleaks-action ou trufflehog no workflow ci.yml",
      "effort": "LOW",
      "impact": "HIGH"
    },
    {
      "priority": 3,
      "action": "Corrigir logging de secrets",
      "description": "Remover impressao parcial de SUPABASE_KEY em REVIEW_NEEDED_testar_supabase_conexao.py",
      "effort": "LOW",
      "impact": "MEDIUM"
    },
    {
      "priority": 4,
      "action": "Revisar grants para 'anon' role",
      "description": "Avaliar se funcoes RPC devem ser acessiveis anonimamente ou apenas para authenticated",
      "effort": "LOW",
      "impact": "MEDIUM"
    },
    {
      "priority": 5,
      "action": "Documentar ativacao de hooks",
      "description": "Adicionar instrucao 'git config core.hooksPath .githooks' no README",
      "effort": "LOW",
      "impact": "LOW"
    },
    {
      "priority": 6,
      "action": "Verificar rotacao de credenciais via browser",
      "description": "Confirmar no Supabase Dashboard que service key foi efetivamente rotacionada apos incidente",
      "effort": "LOW",
      "impact": "CRITICAL"
    }
  ],

  "blocking_issues": [],

  "artifacts_checked": [
    ".gitignore",
    ".env (existencia verificada, conteudo nao lido)",
    "frontend/.env (existencia verificada, conteudo nao lido)",
    "config/.env.example",
    "frontend/.env.example",
    ".streamlit/secrets.toml.example",
    ".github/workflows/ache-sucatas.yml",
    ".github/workflows/ci.yml",
    ".githooks/pre-commit",
    "data/sql/schemas_v13_supabase.sql",
    "frontend/supabase/supabase_infrastructure_public.sql",
    "frontend/supabase/supabase_infrastructure.sql",
    "frontend/supabase/week2_schema.sql",
    "frontend/src/lib/supabase.ts",
    "src/core/supabase_repository.py",
    "src/core/supabase_storage.py",
    "src/scripts/REVIEW_NEEDED_testar_supabase_conexao.py",
    "src/scripts/rotacionar_credenciais.py",
    "src/scripts/instalar_hooks_seguranca.py",
    "docs/GUIA_SEGURANCA_MAXIMA.md",
    "Git history (commits recentes e busca por secrets)"
  ],

  "summary": {
    "total_findings": 12,
    "critical": 0,
    "high": 1,
    "medium": 5,
    "low": 4,
    "info": 2,
    "positive_controls": 8,
    "blocking_issues": 0,
    "overall_assessment": "Projeto possui boa postura de seguranca com controles fundamentais implementados (RLS, .gitignore, GitHub Secrets, audit logging). Incidente de exposicao de credenciais foi identificado e mitigado. Recomenda-se adicionar camadas adicionais de protecao no CI/CD (dependabot, secrets scanning) e verificar efetividade da rotacao de credenciais via browser."
  }
}
