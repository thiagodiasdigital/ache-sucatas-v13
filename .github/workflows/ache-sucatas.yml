name: ACHE SUCATAS - Coleta e Processamento

on:
  schedule:
    # 3x ao dia: 00:00, 08:00, 16:00 UTC (21:00, 05:00, 13:00 BRT)
    - cron: '0 0,8,16 * * *'

  workflow_dispatch:
    inputs:
      run_miner:
        description: 'Executar Miner V18'
        type: boolean
        default: true
      run_auditor:
        description: 'Executar Auditor V19'
        type: boolean
        default: true
      run_leiloesjudiciais:
        description: 'Executar Leiloes Judiciais'
        type: boolean
        default: false
      auditor_limit:
        description: 'Limite de editais para Auditor (0 = sem limite)'
        type: number
        default: 0
      reprocess_all:
        description: 'Reprocessar TODOS editais (corrigir dados legados)'
        type: boolean
        default: false

# =============================================================================
# CONCURRENCY: Evita execu칞칫es paralelas do pipeline
# =============================================================================
# Se uma execu칞칚o estiver em andamento, a pr칩xima aguarda na fila.
# cancel-in-progress: false = N츾O cancela execu칞칚o anterior (evita perda de dados)
concurrency:
  group: ache-sucatas-pipeline
  cancel-in-progress: false

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
  ENABLE_SUPABASE: 'true'
  ENABLE_SUPABASE_STORAGE: 'true'
  ENABLE_LOCAL_BACKUP: 'false'
  PYTHON_VERSION: '3.11'
  # Timezone expl칤cito para logs e datas em hor치rio de Bras칤lia
  TZ: America/Sao_Paulo

jobs:
  # ==========================================================================
  # JOB 1: MINER V18 - Coleta de novos editais (com filtro de data passada)
  # ==========================================================================
  miner:
    name: Miner V18 - Coleta
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'schedule' || github.event.inputs.run_miner == 'true' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Print environment info
        id: env_info
        run: |
          echo "=== Git SHA ==="
          GIT_SHA=$(git rev-parse HEAD)
          echo $GIT_SHA
          echo "git_sha=$GIT_SHA" >> $GITHUB_OUTPUT
          echo ""
          echo "=== Python version ==="
          python --version
          echo ""
          echo "=== Installed packages (top 20) ==="
          pip freeze | head -20

      - name: Generate run report (anti-drift)
        run: |
          cat > run_report.json << EOF
          {
            "git_sha": "${{ steps.env_info.outputs.git_sha }}",
            "run_id": "${{ github.run_id }}",
            "run_number": "${{ github.run_number }}",
            "workflow": "ache-sucatas",
            "job": "miner",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "event": "${{ github.event_name }}",
            "ref": "${{ github.ref }}"
          }
          EOF
          cat run_report.json

      - name: Verify Supabase connection
        env:
          PYTHONPATH: src/core
        run: |
          python -c "
          from supabase_repository import SupabaseRepository
          repo = SupabaseRepository()
          if repo.enable_supabase:
              count = repo.contar_editais()
              print(f'Conexao OK - Editais no banco: {count}')
          else:
              print('ERRO: Supabase nao conectado')
              exit(1)
          "

      - name: Run Miner V18
        env:
          PYTHONPATH: src/core
        run: python src/core/ache_sucatas_miner_v18.py
        timeout-minutes: 30

      - name: Upload metrics artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: miner-metrics-${{ github.run_number }}
          path: |
            ache_sucatas_metrics_v18.jsonl
            .ache_sucatas_checkpoint_v18.json
            run_report.json
          retention-days: 30

  # ==========================================================================
  # JOB 2: AUDITOR V19 - Processamento de editais (URL + Data Fix)
  # ==========================================================================
  auditor:
    name: Auditor V19 - Processamento
    runs-on: ubuntu-latest
    needs: miner
    if: |
      always() &&
      (needs.miner.result == 'success' || needs.miner.result == 'skipped') &&
      (github.event_name == 'schedule' || github.event.inputs.run_auditor == 'true')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Print environment info
        id: env_info_auditor
        run: |
          echo "=== Git SHA ==="
          GIT_SHA=$(git rev-parse HEAD)
          echo $GIT_SHA
          echo "git_sha=$GIT_SHA" >> $GITHUB_OUTPUT
          echo ""
          echo "=== Python version ==="
          python --version
          echo ""
          echo "=== Installed packages (top 20) ==="
          pip freeze | head -20

      - name: Generate run report (anti-drift)
        run: |
          cat > auditor_run_report.json << EOF
          {
            "git_sha": "${{ steps.env_info_auditor.outputs.git_sha }}",
            "run_id": "${{ github.run_id }}",
            "run_number": "${{ github.run_number }}",
            "workflow": "ache-sucatas",
            "job": "auditor",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "event": "${{ github.event_name }}",
            "ref": "${{ github.ref }}"
          }
          EOF
          cat auditor_run_report.json

      - name: Run Auditor V19
        env:
          PYTHONPATH: src/core
        run: |
          LIMIT="${{ github.event.inputs.auditor_limit }}"
          REPROCESS="${{ github.event.inputs.reprocess_all }}"

          ARGS=""
          if [ "$LIMIT" != "0" ] && [ -n "$LIMIT" ]; then
            ARGS="$ARGS --limit $LIMIT"
          fi
          if [ "$REPROCESS" == "true" ]; then
            ARGS="$ARGS --reprocess-all"
          fi

          python src/core/cloud_auditor_v19.py $ARGS
        timeout-minutes: 60

      - name: Upload results artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: auditor-results-${{ github.run_number }}
          path: |
            analise_editais_v19.csv
            auditor_run_report.json
          retention-days: 30
          if-no-files-found: ignore

  # ==========================================================================
  # JOB 3: LEILOES JUDICIAIS - Coleta de ve칤culos via API
  # ==========================================================================
  leiloesjudiciais:
    name: Leiloes Judiciais - Coleta
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.run_leiloesjudiciais == 'true' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Leiloes Judiciais Emit
        env:
          PYTHONPATH: .
        run: python -m connectors.leiloesjudiciais.emit
        timeout-minutes: 30

  # ==========================================================================
  # JOB 4: VERIFICACAO - Status final e detec칞칚o de anomalias
  # ==========================================================================
  verify:
    name: Verificacao Final
    runs-on: ubuntu-latest
    needs: [miner, auditor, leiloesjudiciais]
    if: always()
    outputs:
      editais_novos: ${{ steps.metrics.outputs.editais_novos }}
      total_editais: ${{ steps.metrics.outputs.total_editais }}
      has_anomaly: ${{ steps.metrics.outputs.has_anomaly }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Print environment info
        run: |
          echo "=== Git SHA ==="
          git rev-parse HEAD
          echo ""
          echo "=== Python version ==="
          python --version
          echo ""
          echo "=== Installed packages (top 20) ==="
          pip freeze | head -20

      - name: Verify database status and collect metrics
        id: metrics
        env:
          PYTHONPATH: src/core
        run: |
          python -c "
          import os
          from supabase_repository import SupabaseRepository
          repo = SupabaseRepository()
          if repo.enable_supabase:
              count = repo.contar_editais()
              print('=' * 60)
              print('VERIFICACAO FINAL')
              print('=' * 60)
              print(f'Total de editais no banco: {count}')

              # Exportar metricas para outputs
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write(f'total_editais={count}\n')

              # Buscar ultima execucao
              editais_novos = 0
              try:
                  resp = repo.client.table('execucoes_miner').select('*').order('execution_start', desc=True).limit(1).execute()
                  if resp.data:
                      exec_data = resp.data[0]
                      print(f'Ultima execucao: {exec_data.get(\"execution_start\")}')
                      print(f'Status: {exec_data.get(\"status\")}')
                      editais_novos = exec_data.get('editais_novos', 0) or 0
                      print(f'Novos editais: {editais_novos}')
              except Exception as e:
                  print(f'Erro ao buscar execucoes: {e}')

              # Exportar editais_novos e detectar anomalia
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write(f'editais_novos={editais_novos}\n')
                  # Anomalia: execucao agendada com 0 editais novos (pode indicar problema)
                  has_anomaly = 'true' if editais_novos == 0 and '${{ github.event_name }}' == 'schedule' else 'false'
                  f.write(f'has_anomaly={has_anomaly}\n')

              print('=' * 60)
          else:
              print('ERRO: Supabase nao conectado')
              exit(1)
          "

      - name: Summary
        run: |
          echo "## ACHE SUCATAS - Execucao Concluida" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Miner V18 | ${{ needs.miner.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Auditor V19 | ${{ needs.auditor.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Leiloes Judiciais | ${{ needs.leiloesjudiciais.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Metricas" >> $GITHUB_STEP_SUMMARY
          echo "- Total editais: ${{ steps.metrics.outputs.total_editais }}" >> $GITHUB_STEP_SUMMARY
          echo "- Editais novos: ${{ steps.metrics.outputs.editais_novos }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Executado em: $(date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY

  # ==========================================================================
  # JOB 4: NOTIFICACAO - Email quando falhar
  # ==========================================================================
  notify-failure:
    name: Notificar Falha por Email
    runs-on: ubuntu-latest
    needs: [miner, auditor, leiloesjudiciais]
    if: failure()

    steps:
      - name: Log failure
        run: |
          echo "::error::ACHE SUCATAS falhou!"
          echo "Miner: ${{ needs.miner.result }}"
          echo "Auditor: ${{ needs.auditor.result }}"
          echo "Leiloes Judiciais: ${{ needs.leiloesjudiciais.result }}"

      - name: Send email notification
        uses: dawidd6/action-send-mail@v8
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_ADDRESS }}
          password: ${{ secrets.EMAIL_APP_PASSWORD }}
          subject: "丘멆잺 ACHE SUCATAS - Workflow Falhou"
          to: ${{ secrets.EMAIL_ADDRESS }}
          from: ACHE SUCATAS <${{ secrets.EMAIL_ADDRESS }}>
          body: |
            O workflow ACHE SUCATAS falhou!

            ----------------------------------------
            DETALHES DA EXECU칂츾O
            ----------------------------------------

            Reposit칩rio: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Evento: ${{ github.event_name }}

            ----------------------------------------
            STATUS DOS JOBS
            ----------------------------------------

            Miner V18:          ${{ needs.miner.result }}
            Auditor V19:        ${{ needs.auditor.result }}
            Leiloes Judiciais:  ${{ needs.leiloesjudiciais.result }}

            ----------------------------------------
            A칂츾O NECESS츼RIA
            ----------------------------------------

            Verifique os logs em:
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ----------------------------------------
            Enviado automaticamente pelo GitHub Actions

  # ==========================================================================
  # JOB 5: NOTIFICACAO - Email quando detectar anomalia (0 editais coletados)
  # ==========================================================================
  notify-anomaly:
    name: Notificar Anomalia por Email
    runs-on: ubuntu-latest
    needs: [miner, auditor, leiloesjudiciais, verify]
    if: |
      always() &&
      needs.verify.outputs.has_anomaly == 'true' &&
      needs.miner.result == 'success'

    steps:
      - name: Log anomaly
        run: |
          echo "::warning::ACHE SUCATAS - Anomalia detectada: 0 editais novos coletados"
          echo "Total editais: ${{ needs.verify.outputs.total_editais }}"
          echo "Editais novos: ${{ needs.verify.outputs.editais_novos }}"

      - name: Send email notification
        uses: dawidd6/action-send-mail@v8
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_ADDRESS }}
          password: ${{ secrets.EMAIL_APP_PASSWORD }}
          subject: "游늵 ACHE SUCATAS - Anomalia: 0 editais coletados"
          to: ${{ secrets.EMAIL_ADDRESS }}
          from: ACHE SUCATAS <${{ secrets.EMAIL_ADDRESS }}>
          body: |
            O pipeline ACHE SUCATAS executou com sucesso, mas coletou 0 editais novos.

            Isso pode indicar:
            - API do PNCP fora do ar ou com problemas
            - Nenhum edital novo publicado no per칤odo
            - Problema nos filtros ou termos de busca

            ----------------------------------------
            M칄TRICAS
            ----------------------------------------

            Total de editais no banco: ${{ needs.verify.outputs.total_editais }}
            Editais novos coletados:   ${{ needs.verify.outputs.editais_novos }}

            ----------------------------------------
            DETALHES DA EXECU칂츾O
            ----------------------------------------

            Reposit칩rio: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Evento: ${{ github.event_name }}

            ----------------------------------------
            A칂츾O SUGERIDA
            ----------------------------------------

            1. Verifique se a API PNCP est치 respondendo
            2. Execute manualmente para confirmar comportamento
            3. Verifique os logs em:
               https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ----------------------------------------
            Enviado automaticamente pelo GitHub Actions
