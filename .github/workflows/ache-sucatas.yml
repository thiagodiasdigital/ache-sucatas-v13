name: ACHE SUCATAS - Coleta e Processamento

on:
  schedule:
    # 3x ao dia: 00:00, 08:00, 16:00 UTC (21:00, 05:00, 13:00 BRT)
    - cron: '0 0,8,16 * * *'

  workflow_dispatch:
    inputs:
      run_miner:
        description: 'Executar Miner V12'
        type: boolean
        default: true
      run_auditor:
        description: 'Executar Auditor V15'
        type: boolean
        default: true
      auditor_limit:
        description: 'Limite de editais para Auditor (0 = sem limite)'
        type: number
        default: 0

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
  ENABLE_SUPABASE: 'true'
  ENABLE_SUPABASE_STORAGE: 'true'
  ENABLE_LOCAL_BACKUP: 'false'
  PYTHON_VERSION: '3.11'

jobs:
  # ==========================================================================
  # JOB 1: MINER V12 - Coleta de novos editais (com data_leilao da API)
  # ==========================================================================
  miner:
    name: Miner V12 - Coleta
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'schedule' || github.event.inputs.run_miner == 'true' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify Supabase connection
        env:
          PYTHONPATH: src/core
        run: |
          python -c "
          from supabase_repository import SupabaseRepository
          repo = SupabaseRepository()
          if repo.enable_supabase:
              count = repo.contar_editais()
              print(f'Conexao OK - Editais no banco: {count}')
          else:
              print('ERRO: Supabase nao conectado')
              exit(1)
          "

      - name: Run Miner V12
        env:
          PYTHONPATH: src/core
        run: python src/core/ache_sucatas_miner_v12.py
        timeout-minutes: 30

      - name: Upload metrics artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: miner-metrics-${{ github.run_number }}
          path: |
            ache_sucatas_metrics_v12.jsonl
            .ache_sucatas_checkpoint_v12.json
          retention-days: 30

  # ==========================================================================
  # JOB 2: AUDITOR V15 - Processamento de editais (com API fallback)
  # ==========================================================================
  auditor:
    name: Auditor V15 - Processamento
    runs-on: ubuntu-latest
    needs: miner
    if: |
      always() &&
      (needs.miner.result == 'success' || needs.miner.result == 'skipped') &&
      (github.event_name == 'schedule' || github.event.inputs.run_auditor == 'true')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Auditor V15
        env:
          PYTHONPATH: src/core
        run: |
          LIMIT="${{ github.event.inputs.auditor_limit }}"
          if [ "$LIMIT" != "0" ] && [ -n "$LIMIT" ]; then
            python src/core/cloud_auditor_v15.py --limit $LIMIT
          else
            python src/core/cloud_auditor_v15.py
          fi
        timeout-minutes: 60

      - name: Upload results artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: auditor-results-${{ github.run_number }}
          path: |
            analise_editais_v15.csv
          retention-days: 30
          if-no-files-found: ignore

  # ==========================================================================
  # JOB 3: VERIFICACAO - Status final
  # ==========================================================================
  verify:
    name: Verificacao Final
    runs-on: ubuntu-latest
    needs: [miner, auditor]
    if: always()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify database status
        env:
          PYTHONPATH: src/core
        run: |
          python -c "
          from supabase_repository import SupabaseRepository
          repo = SupabaseRepository()
          if repo.enable_supabase:
              count = repo.contar_editais()
              print('=' * 60)
              print('VERIFICACAO FINAL')
              print('=' * 60)
              print(f'Total de editais no banco: {count}')

              # Buscar ultima execucao
              try:
                  resp = repo.client.table('execucoes_miner').select('*').order('execution_start', desc=True).limit(1).execute()
                  if resp.data:
                      exec_data = resp.data[0]
                      print(f'Ultima execucao: {exec_data.get(\"execution_start\")}')
                      print(f'Status: {exec_data.get(\"status\")}')
                      print(f'Novos editais: {exec_data.get(\"editais_novos\", 0)}')
              except Exception as e:
                  print(f'Erro ao buscar execucoes: {e}')

              print('=' * 60)
          else:
              print('ERRO: Supabase nao conectado')
              exit(1)
          "

      - name: Summary
        run: |
          echo "## ACHE SUCATAS - Execucao Concluida" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Miner V12 | ${{ needs.miner.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Auditor V15 | ${{ needs.auditor.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Executado em: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  # ==========================================================================
  # JOB 4: NOTIFICACAO - Email quando falhar
  # ==========================================================================
  notify-failure:
    name: Notificar Falha por Email
    runs-on: ubuntu-latest
    needs: [miner, auditor]
    if: failure()

    steps:
      - name: Log failure
        run: |
          echo "::error::ACHE SUCATAS falhou!"
          echo "Miner: ${{ needs.miner.result }}"
          echo "Auditor: ${{ needs.auditor.result }}"

      - name: Send email notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_ADDRESS }}
          password: ${{ secrets.EMAIL_APP_PASSWORD }}
          subject: "⚠️ ACHE SUCATAS - Workflow Falhou"
          to: ${{ secrets.EMAIL_ADDRESS }}
          from: ACHE SUCATAS <${{ secrets.EMAIL_ADDRESS }}>
          body: |
            O workflow ACHE SUCATAS falhou!

            ----------------------------------------
            DETALHES DA EXECUÇÃO
            ----------------------------------------

            Repositório: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Evento: ${{ github.event_name }}

            ----------------------------------------
            STATUS DOS JOBS
            ----------------------------------------

            Miner V12:   ${{ needs.miner.result }}
            Auditor V15: ${{ needs.auditor.result }}

            ----------------------------------------
            AÇÃO NECESSÁRIA
            ----------------------------------------

            Verifique os logs em:
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ----------------------------------------
            Enviado automaticamente pelo GitHub Actions
